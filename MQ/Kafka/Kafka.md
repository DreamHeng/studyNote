# Kafka

## 1.初识Kafka

​	**Apache Kafka**是一款**开源**的**消息引擎系统**，也是一个**分布式流处理平台（Distributed Streaming Platform）**。属于**Message System**。

#### 1.1.消息引擎系统

​	消息引擎系统是一组**规范**。企业利用这组规范在**不同系统**间传递语义准确的**消息**，实现**松耦合**的**异步**消息传递。如系统A发送消息给消息引擎系统，系统B从消息引擎系统中获取消息。

重点：

-  消息引擎传输的对象是消息；


- 如何传输消息属于消息引擎设计机制的一部分。

#### 1.2.Kafka待传输消息的格式设计

​	把消息结构化，再转化为纯二进制的字节序列，在进行传输。

#### 1.3.Kafka传输协议的设定

​	Kafka支持两种消息引擎模型：

- **点对点模型**，也叫作消息队列模型，也就是一个系统发送的消息只能被特定的某个系统接收，其他系统不能接收。
- **发布/订阅模型**，与点对点模型不同的是，它有一个主题的概念，也可以称为逻辑语义相近的消息容器。该模型的发送方称为发布方，接收方称为订阅方。可以有多个发布方向同一个主题发送消息，这个主题的消息可以被多个订阅者接收消息。

#### 1.4.消息引擎系统的作用

- **流量削峰**，防止出现上游系统流量激增，导致下游系统压力过大，无法处理进而崩溃的情况。上游系统将需要处理的任务放进消息引擎系统中，下游逐个取，逐一执行。
- 应用解耦，降低系统间的耦合，提高容错率。上游将需要处理的任务放入消息引擎，等待下游系统正常时来接收任务处理。
- 数据分发，提高系统间流通性，不同系统间不用考虑谁来处理、发送数据，只需要从消息引擎系统中获取特定格式的数据就ok。

#### 1.5.Kafka的角色和名词

##### 角色：

**消息（Record）**：Kafka处理的主要对象；

**主题（Topic）**：承载消息的逻辑容器，在实际使用中多用来区分具体的业务；

​	**分区（Partition）**：物理分隔，解决水平扩展问题，每个主题下的分区编号从0开始，

​		**副本（Replica）**：每个分区有N个副本，只有一个领导者副本（Leader Replica）和N-1个追随者副本（Follower Replica），领导者副本向外提供服务，追随者副本只向领导者副本请求最新消息保持一致；

客户端：

​	**生产者（Producer）**：向主题发布消息的系统；

​	**消费者（Consumer）**：订阅消息的系统；

服务器端：

​	**Broker**：负责接收和处理客户端发送过来的请求，对消息进行持久化，多个Broker组成Kafka集群。



##### 名词：

**消息位移（Offset）**：生产者向分区写入消息时，每条消息在分区中的位置信息表示，从0开始；

**消息日志（Log）**：Kafka用来保存数据的文件，用来持久化数据的，采用追加数据的形式，只能追加写（Append-only），用性能好的顺序I/O写操作，是Kafka实现高吞吐的一个手段；

​	**日志段（Log Segment）**：写满一个日志段就新开一个日志段继续写数据，Kafka会有定时任务检查老的日志段是否可以回收；

**消费者组（Consumer Group）**：Kafka实现点对点模型的方法，由多个消费者组成用来消费一组主题，这组主题的每个分区都只会被组内的一个消费者消费，其他消费者不能消费；主要用来实现高吞吐；消费者组的某个消费者挂掉，Kafka可以检测到，会将Failed消费者之前负责的分区转移给其它活着的消费者，这就是重平衡（Rebalance）；

**消费者位移（Consumer Offset）**：记录消费者在分区上的消费位置。

#### 1.6.Kafka实现高可用的·手段

- 多个Broder组成集群；
- 备份机制（Replication），即副本实现。

#### 1.7.Kafka的不同版本

- Apache Kafka，也称社区版 Kafka。优势在于迭代速度快，社区响应度高，使用它可以

  让你有更高的把控度；缺陷在于仅提供基础核心组件，缺失一些高级的特性。

- Confluent Kafka，Confluent 公司提供的 Kafka。优势在于集成了很多高级特性且由

  Kafka 原班人马打造，质量上有保证；缺陷在于相关文档资料不全，普及率较低，没有太

  多可供参考的范例。

- CDH/HDP Kafka，大数据云公司提供的 Kafka，内嵌 Apache Kafka。优势在于操作简

  单，节省运维成本；缺陷在于把控度低，演进速度较慢。

#### 1.8.Kafka的版本号演进

- 0.7上古版本，只有基础的消息队列功能；
- 0.8版本引入副本机制，成为一款真正的分布式高可靠消息队列解决方案；0.8.2.2消费者API较稳定，生产者APIBug较多，尽量不使用；
- 0.9增加了基础的安全认证/权限功能，使用Java重写了消费者API，引入了Kafka Connect组件用于实现高性能的数据抽取；此版本生产者API稳定，消费者API不稳定；
- 0.10引入了Kafka Streams，正式升级为分布式流处理平台；0.10.2.2消费者API稳定；
- 0.11，引入两个，一个是提供幂等性Producer API以及事务（Transaction）API，一个是对Kafka消息格式做了重构；0.11.0.3消息引擎功能已经很完善；
- 1.0和2.0主要是Kafka Streams的各种改进消息引擎无重大更新，如果是Streams用户，选择2.0。